<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste - Firebase Config</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
        button { padding: 10px 20px; margin: 10px; }
    </style>
</head>
<body>
    <h1>Teste de Configuração Firebase</h1>

    <button onclick="testFirebase()">Testar Firebase</button>
    <button onclick="testAuth()">Testar Auth</button>
    <button onclick="testFirestore()">Testar Firestore</button>
    <button onclick="testAdminUser()">Verificar Usuário Admin</button>
    <button onclick="testLogin()">Testar Login</button>

    <div id="results"></div>

    <!-- Form de teste de login -->
    <div style="margin-top: 20px; padding: 20px; border: 1px solid #ccc;">
        <h3>Teste de Login</h3>
        <p><strong>IMPORTANTE:</strong> Primeiro crie um usuário no Firebase Console > Authentication</p>
        <input type="email" id="testEmail" placeholder="Email" value="admin@coisarapida.com">
        <input type="password" id="testPassword" placeholder="Senha" value="123456">
        <button onclick="performTestLogin()">Fazer Login</button>
        <button onclick="createTestUser()">Criar Usuário de Teste</button>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>

    <script>
        // Configuração do Firebase (mesma do config.js)
        const firebaseConfig = {
            apiKey: "AIzaSyB1xYkAfyxV3ouwRaBNl79vOkrpdMAub7s",
            authDomain: "coisarapida-4d39b.firebaseapp.com",
            projectId: "coisarapida-4d39b",
            storageBucket: "coisarapida-4d39b.appspot.com",
            messagingSenderId: "276388822522",
            appId: "1:276388822522:android:9e947caf9d26b914f77843"
        };

        // Inicializar Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }

        const auth = firebase.auth();
        const db = firebase.firestore();

        function log(message, type = 'info') {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = type;
            div.innerHTML = `<strong>${new Date().toLocaleTimeString()}:</strong> ${message}`;
            results.appendChild(div);
            console.log(message);
        }

        async function testFirebase() {
            try {
                log('Firebase inicializado com sucesso!', 'success');
                log(`Versão: ${firebase.SDK_VERSION}`);
                log(`Apps ativos: ${firebase.apps.length}`);
            } catch (error) {
                log(`Erro no Firebase: ${error.message}`, 'error');
            }
        }

        async function testAuth() {
            try {
                const user = auth.currentUser;
                if (user) {
                    log(`Usuário logado: ${user.email} (UID: ${user.uid})`, 'success');
                } else {
                    log('Nenhum usuário logado', 'info');
                }
            } catch (error) {
                log(`Erro no Auth: ${error.message}`, 'error');
            }
        }

        async function testFirestore() {
            try {
                // Testar leitura de uma coleção pública
                const snapshot = await db.collection('itens').limit(1).get();
                log(`Firestore OK - Itens encontrados: ${snapshot.size}`, 'success');

                // Testar regras de segurança
                try {
                    const usersSnapshot = await db.collection('usuarios').limit(1).get();
                    log(`Regras OK - Usuários acessíveis: ${usersSnapshot.size}`, 'success');
                } catch (error) {
                    log(`Regras de segurança ativas: ${error.message}`, 'info');
                }

            } catch (error) {
                log(`Erro no Firestore: ${error.message}`, 'error');
            }
        }

        async function performTestLogin() {
            const email = document.getElementById('testEmail').value;
            const password = document.getElementById('testPassword').value;

            log(`Tentando fazer login com: ${email}`);

            try {
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                log(`Login bem-sucedido! UID: ${userCredential.user.uid}`, 'success');
            } catch (error) {
                log(`Erro no login: ${error.code} - ${error.message}`, 'error');
            }
        }

        async function createTestUser() {
            const email = document.getElementById('testEmail').value;
            const password = document.getElementById('testPassword').value;

            log(`Criando usuário de teste: ${email}`);

            try {
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                log(`Usuário criado! UID: ${userCredential.user.uid}`, 'success');

                // Criar documento no Firestore
                await db.collection('usuarios').doc(userCredential.user.uid).set({
                    nome: 'Administrador',
                    email: email,
                    isAdmin: true,
                    dataCriacao: new Date()
                });

                log('Documento do usuário criado no Firestore com permissões admin!', 'success');

            } catch (error) {
                log(`Erro ao criar usuário: ${error.code} - ${error.message}`, 'error');
            }
        }

        // Listener de auth state
        auth.onAuthStateChanged((user) => {
            if (user) {
                log(`Auth state: Logado como ${user.email}`);
            } else {
                log('Auth state: Deslogado');
            }
        });
    </script>
</body>
</html>
